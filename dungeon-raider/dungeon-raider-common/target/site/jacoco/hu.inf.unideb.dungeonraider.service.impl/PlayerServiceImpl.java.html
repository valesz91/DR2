<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PlayerServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Dungeon Raider Common Module</a> &gt; <a href="index.source.html" class="el_package">hu.inf.unideb.dungeonraider.service.impl</a> &gt; <span class="el_source">PlayerServiceImpl.java</span></div><h1>PlayerServiceImpl.java</h1><pre class="source lang-java linenums">package hu.inf.unideb.dungeonraider.service.impl;

import java.util.LinkedList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.Assert;

import hu.inf.unideb.dungeonraider.dao.ItemDao;
import hu.inf.unideb.dungeonraider.dao.PlayersCharacterDao;
import hu.inf.unideb.dungeonraider.domain.Armor;
import hu.inf.unideb.dungeonraider.domain.Item;
import hu.inf.unideb.dungeonraider.domain.ItemType;
import hu.inf.unideb.dungeonraider.domain.PlayersCharacter;
import hu.inf.unideb.dungeonraider.domain.Race;
import hu.inf.unideb.dungeonraider.domain.Shield;
import hu.inf.unideb.dungeonraider.domain.Weapon;
import hu.inf.unideb.dungeonraider.service.ConflictingEntityException;
import hu.inf.unideb.dungeonraider.service.ItemException;
import hu.inf.unideb.dungeonraider.service.MissingEntityException;
import hu.inf.unideb.dungeonraider.service.PlayerService;

@Service(&quot;playerService&quot;)
<span class="fc" id="L26">public class PlayerServiceImpl implements PlayerService {</span>

	@Autowired
	private PlayersCharacterDao characterDao;
	@Autowired
	private ItemDao itemDao;

	@Override
	@Transactional
	public void createNewCharacter(Integer health, Integer dexterity, Integer strength, Integer quickness, String name, String password) {

		// PlayersCharacter actual = characterDao.findByNameAndPassword(name, password);

<span class="nc" id="L39">		PlayersCharacter maybeConflictByName = characterDao.findByName(name);</span>
<span class="nc" id="L40">		List&lt;String&gt; conflictingPropertyNames = new LinkedList&lt;String&gt;();</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">		if (maybeConflictByName != null) {</span>
<span class="nc" id="L42">			conflictingPropertyNames.add(&quot;name&quot;);</span>
<span class="nc" id="L43">			throw new ConflictingEntityException(conflictingPropertyNames);</span>
			// if (actual != null) {
			// List&lt;String&gt; conflictingPropertyNames = new LinkedList&lt;String&gt;();
			// if (actual.getName().equals(name))
			// conflictingPropertyNames.add(&quot;name&quot;);
			// if (actual.getPassword().equals(password))
			// conflictingPropertyNames.add(&quot;password&quot;);
			//
			// throw new ConflictingEntityException(conflictingPropertyNames);
		} else {

<span class="nc" id="L54">			PlayersCharacter character = new PlayersCharacter();</span>
<span class="nc" id="L55">			character.setStrength(strength);</span>
<span class="nc" id="L56">			character.setDexterity(dexterity);</span>
<span class="nc" id="L57">			character.setQuickness(quickness);</span>
<span class="nc" id="L58">			character.setHealth(health);</span>

<span class="nc" id="L60">			character.setActualExp(0);</span>
<span class="nc" id="L61">			character.setAttackPoints(20 + quickness * 2);</span>
<span class="nc" id="L62">			Double ch = strength / 2.0;</span>
<span class="nc" id="L63">			Integer damagePluss = ch.intValue();</span>
<span class="nc" id="L64">			character.setDamagePoints(1 + damagePluss);</span>
<span class="nc" id="L65">			character.setDefendPoints(40 + dexterity * 2);</span>
<span class="nc" id="L66">			character.setGold(100);</span>
<span class="nc" id="L67">			character.setHealthPoint(15 + health);</span>
<span class="nc" id="L68">			character.setLoadCapacity(50.0 + (strength.doubleValue() * 2.0));</span>

<span class="nc" id="L70">			character.setInventory(new LinkedList&lt;Item&gt;());</span>
<span class="nc" id="L71">			character.setPosition(null);</span>
<span class="nc" id="L72">			character.setName(name);</span>
<span class="nc" id="L73">			character.setPassword(password);</span>
<span class="nc" id="L74">			character.setRace(Race.HUMAN);</span>

			// TODO set pozition tothe map first position
<span class="nc" id="L77">			characterDao.saveOrUpdatePlayersCharacter(character);</span>
		}

<span class="nc" id="L80">	}</span>

	@Override
	@Transactional
	public boolean equipItem(ItemType type, Integer itemId, Integer characterId) {

<span class="nc" id="L86">		Assert.notNull(characterId);</span>
<span class="nc" id="L87">		Assert.notNull(itemId);</span>
<span class="nc" id="L88">		Assert.notNull(type);</span>
<span class="nc" id="L89">		PlayersCharacter pc = characterDao.findById(characterId);</span>

<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (pc == null) {</span>
<span class="nc" id="L92">			throw new MissingEntityException(characterId);</span>
		}
<span class="nc bnc" id="L94" title="All 4 branches missed.">		switch (type) {</span>
		case SHIELD:
<span class="nc" id="L96">			Shield toEquipS = itemDao.findShieldById(itemId);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">			if (pc.getShields().contains(toEquipS)) {</span>
<span class="nc" id="L98">				pc.getShields().remove(toEquipS);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">				if (pc.getLoadCapacity() &lt; toEquipS.getWeight()) {</span>
<span class="nc" id="L100">					throw new ItemException(&quot;error.tooHeawyItem&quot;);</span>
				} else {
<span class="nc" id="L102">					pc.setActualShield(toEquipS);</span>
<span class="nc" id="L103">					pc.setAttackPoints(pc.getAttackPoints() + toEquipS.getAtkMinus());</span>
<span class="nc" id="L104">					pc.setDamagePoints(pc.getDamagePoints() + toEquipS.getDefPlus());</span>
<span class="nc" id="L105">					pc.setLoadCapacity(pc.getLoadCapacity() - toEquipS.getWeight());</span>
				}

<span class="nc" id="L108">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L109">				return true;</span>
			}

		case ARMOR:
<span class="nc" id="L113">			Armor toEquipA = itemDao.findArmorById(itemId);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (pc.getArmors().contains(toEquipA)) {</span>
<span class="nc" id="L115">				pc.getArmors().remove(toEquipA);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">				if (pc.getLoadCapacity() &lt; toEquipA.getWeight()) {</span>
<span class="nc" id="L117">					throw new ItemException(&quot;error.tooHeawyItem&quot;);</span>
				} else {
<span class="nc" id="L119">					pc.setActualArmor(toEquipA);</span>
<span class="nc" id="L120">					pc.setAttackPoints(pc.getAttackPoints() + toEquipA.getAtkMinus());</span>
<span class="nc" id="L121">					pc.setDamagePoints(pc.getDamagePoints() + toEquipA.getDefPlus());</span>
<span class="nc" id="L122">					pc.setHealth(pc.getHealth() + toEquipA.getHealthPlus());</span>
<span class="nc" id="L123">					pc.setLoadCapacity(pc.getLoadCapacity() - toEquipA.getWeight());</span>
				}

<span class="nc" id="L126">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L127">				return true;</span>

			}
		case WEAPON:
<span class="nc" id="L131">			Weapon toEquipW = itemDao.findWeaponById(itemId);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (pc.getWeapons().contains(toEquipW)) {</span>
<span class="nc" id="L133">				pc.getWeapons().remove(toEquipW);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				if (pc.getLoadCapacity() &lt; toEquipW.getWeight()) {</span>
<span class="nc" id="L135">					throw new ItemException(&quot;error.tooHeawyItem&quot;);</span>
				} else {
<span class="nc" id="L137">					pc.setActualWeapon(toEquipW);</span>
<span class="nc" id="L138">					pc.setAttackPoints(pc.getAttackPoints() + toEquipW.getAtk());</span>
<span class="nc" id="L139">					pc.setDamagePoints(pc.getDamagePoints() + toEquipW.getDef());</span>
<span class="nc" id="L140">					pc.setDamagePoints(pc.getDamagePoints() + toEquipW.getDamage());</span>
<span class="nc" id="L141">					pc.setLoadCapacity(pc.getLoadCapacity() - toEquipW.getWeight());</span>
				}
			}
<span class="nc" id="L144">			characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L145">			return true;</span>
		case POTION:
			break;
		}
<span class="nc" id="L149">		return false;</span>

	}

	@Override
	@Transactional
	public boolean dropItem(ItemType type, Integer itemId, Integer characterId) {

<span class="nc" id="L157">		Assert.notNull(characterId);</span>
<span class="nc" id="L158">		Assert.notNull(itemId);</span>
<span class="nc" id="L159">		Assert.notNull(type);</span>
<span class="nc" id="L160">		PlayersCharacter pc = characterDao.findById(characterId);</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">		if (pc == null) {</span>
<span class="nc" id="L163">			throw new MissingEntityException(characterId);</span>
		}
<span class="nc bnc" id="L165" title="All 4 branches missed.">		switch (type) {</span>
		case SHIELD:
<span class="nc" id="L167">			Shield toEquipS = itemDao.findShieldById(itemId);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			if (pc.getShields().contains(toEquipS)) {</span>
<span class="nc" id="L169">				pc.getShields().remove(toEquipS);</span>
<span class="nc" id="L170">				pc.setLoadCapacity(pc.getLoadCapacity() - toEquipS.getWeight());</span>

<span class="nc" id="L172">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L173">				return true;</span>
			}
		case ARMOR:
<span class="nc" id="L176">			Armor toEquipA = itemDao.findArmorById(itemId);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">			if (pc.getArmors().contains(toEquipA)) {</span>
<span class="nc" id="L178">				pc.getArmors().remove(toEquipA);</span>
<span class="nc" id="L179">				pc.setLoadCapacity(pc.getLoadCapacity() - toEquipA.getWeight());</span>

<span class="nc" id="L181">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L182">				return true;</span>
			}

		case WEAPON:
<span class="nc" id="L186">			Weapon toEquipW = itemDao.findWeaponById(itemId);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			if (pc.getWeapons().contains(toEquipW)) {</span>
<span class="nc" id="L188">				pc.getWeapons().remove(toEquipW);</span>
<span class="nc" id="L189">				pc.setLoadCapacity(pc.getLoadCapacity() - toEquipW.getWeight());</span>
<span class="nc" id="L190">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L191">				return true;</span>
			}
		case POTION:
			break;
		}
<span class="nc" id="L196">		return false;</span>

	}

	@Override
	@Transactional
	public boolean unEquipItem(ItemType type, Integer itemId, Integer characterId) {

<span class="nc" id="L204">		Assert.notNull(characterId);</span>
<span class="nc" id="L205">		Assert.notNull(itemId);</span>
<span class="nc" id="L206">		Assert.notNull(type);</span>
<span class="nc" id="L207">		PlayersCharacter pc = characterDao.findById(characterId);</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (pc == null) {</span>
<span class="nc" id="L210">			throw new MissingEntityException(characterId);</span>
		}

<span class="nc bnc" id="L213" title="All 4 branches missed.">		switch (type) {</span>
		case SHIELD:

<span class="nc" id="L216">			Shield toUnEquipS = itemDao.findShieldById(itemId);</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">			if (pc.getActualShield() == toUnEquipS) {</span>
<span class="nc" id="L219">				pc.setActualShield(null);</span>
<span class="nc" id="L220">				pc.getShields().add(toUnEquipS);</span>

<span class="nc" id="L222">				pc.setAttackPoints(pc.getAttackPoints() - toUnEquipS.getAtkMinus());</span>
<span class="nc" id="L223">				pc.setDamagePoints(pc.getDamagePoints() - toUnEquipS.getDefPlus());</span>
<span class="nc" id="L224">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L225">				return true;</span>
			} else {
<span class="nc" id="L227">				throw new ItemException();</span>
			}

		case ARMOR:
<span class="nc" id="L231">			Armor toUnEquipA = itemDao.findArmorById(itemId);</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">			if (pc.getActualArmor() == toUnEquipA) {</span>
<span class="nc" id="L234">				pc.setActualArmor(null);</span>
<span class="nc" id="L235">				pc.getArmors().add(toUnEquipA);</span>

<span class="nc" id="L237">				pc.setAttackPoints(pc.getAttackPoints() - toUnEquipA.getAtkMinus());</span>
<span class="nc" id="L238">				pc.setDamagePoints(pc.getDamagePoints() - toUnEquipA.getDefPlus());</span>
<span class="nc" id="L239">				pc.setHealth(pc.getHealth() - toUnEquipA.getHealthPlus());</span>
<span class="nc" id="L240">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L241">				return true;</span>
			} else {
<span class="nc" id="L243">				throw new ItemException();</span>

			}
		case WEAPON:
<span class="nc" id="L247">			Weapon toUnEquipW = itemDao.findWeaponById(itemId);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			if (pc.getActualWeapon() == toUnEquipW) {</span>
<span class="nc" id="L249">				pc.setActualWeapon(null);</span>
<span class="nc" id="L250">				pc.getWeapons().add(toUnEquipW);</span>

<span class="nc" id="L252">				pc.setAttackPoints(pc.getAttackPoints() - toUnEquipW.getAtk());</span>
<span class="nc" id="L253">				pc.setDamagePoints(pc.getDamagePoints() - toUnEquipW.getDef());</span>
<span class="nc" id="L254">				pc.setDamagePoints(pc.getDamagePoints() - toUnEquipW.getDamage());</span>
<span class="nc" id="L255">				characterDao.saveOrUpdatePlayersCharacter(pc);</span>
<span class="nc" id="L256">				return true;</span>

			} else {
<span class="nc" id="L259">				throw new ItemException();</span>

			}

		case POTION:
			break;
		}

<span class="nc" id="L267">		return false;</span>

	}

	@Override
	@Transactional
	public PlayersCharacter findById(Integer id) {

<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (id != null) {</span>
<span class="nc" id="L276">			return characterDao.findById(id);</span>
		} else
<span class="nc" id="L278">			throw new MissingEntityException(id);</span>
	}

	@Override
	@Transactional
	public PlayersCharacter findByNameAndPassword(String name, String password) {

<span class="nc bnc" id="L285" title="All 6 branches missed.">		if (name != null &amp; password != null) {</span>
<span class="nc" id="L286">			return characterDao.findByNameAndPassword(name, password);</span>
		} else
<span class="nc" id="L288">			throw new MissingEntityException(name);</span>
	}

	@Override
	@Transactional
	public Double calculateItemsWeightByCharacter(Integer id) {
		PlayersCharacter pc;
<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (id != null) {</span>
<span class="nc" id="L296">			pc = characterDao.findById(id);</span>
<span class="nc" id="L297">		} else {</span>
<span class="nc" id="L298">			throw new MissingEntityException(id);</span>
		}

<span class="nc" id="L301">		Double weightsSum = null;</span>

		// FIXME: streamel kéne összeadni

		// List&lt;Item&gt; allItems = pc.getInventory();
		// allItems.addAll(pc.getArmors());
		// allItems.addAll(pc.getWeapons());
		// allItems.addAll(pc.getPotions());

		// for (Item item : pc.getInventory().addAll(pc.getArmors())) {
		// weightsSum += item.getWeight();
		// }
		// for (Item item : pc.getArmors()) {
		// weightsSum += item.getWeight();
		// }

<span class="nc" id="L317">		return 10.0;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>